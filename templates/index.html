<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Design Auditor - Vodafone Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        vodafone: {
                            red: '#E60000',
                            dark: '#333333',
                            gray: '#F4F4F4'
                        }
                    },
                    fontFamily: {
                        sans: ['"Open Sans"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .gradient-text {
            color: #E60000;
        }

        .drop-zone {
            transition: all 0.3s ease;
            background-color: #F9FAFB;
        }

        .drop-zone.dragover {
            border-color: #E60000;
            background-color: rgba(230, 0, 0, 0.05);
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(230, 0, 0, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(230, 0, 0, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(230, 0, 0, 0);
            }
        }

        .animate-pulse-ring {
            animation: pulse-ring 2s infinite;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen selection:bg-red-100 selection:text-red-900">

    <!-- Navbar -->
    <nav class="border-b border-gray-200 bg-white/80 backdrop-blur fixed w-full z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <!-- Vodafone Logo Image -->
                    <div class="w-10 h-10 flex items-center justify-center">
                        <img src="/static/vodafone_icon.png" alt="Vodafone Logo" class="w-full h-full object-contain">
                    </div>
                    <span class="font-bold text-xl tracking-tight text-gray-900">AI Design Auditor</span>
                </div>
                <div class="flex items-center gap-4">
                    <div id="adb-status"
                        class="flex items-center gap-2 px-3 py-1 rounded-full bg-gray-100 text-xs font-medium text-gray-500 border border-gray-200">
                        <div class="w-2 h-2 rounded-full bg-gray-400"></div>
                        Checking ADB...
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-24 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">

        <!-- Hero -->
        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold mb-4 text-gray-900">
                Pixel Perfect <span class="gradient-text">Design Audits</span>
            </h1>
            <p class="text-gray-600 text-lg max-w-2xl mx-auto">
                Upload your Figma designs and let AI verify the implementation against the real app.
            </p>
        </div>

        <!-- Input Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">

            <!-- Figma Upload -->
            <div class="glass rounded-2xl p-6 bg-white">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold flex items-center gap-2 text-gray-800">
                        <i class="fab fa-figma text-gray-900"></i> Figma Designs
                    </h2>
                    <!-- Toggle -->
                    <div class="flex bg-gray-100 rounded-lg p-1 border border-gray-200">
                        <button id="btn-figma-upload"
                            class="px-3 py-1 rounded-md text-sm font-medium bg-white text-gray-900 shadow-sm transition-all"
                            onclick="setFigmaMode('upload')">Upload</button>
                        <button id="btn-figma-link"
                            class="px-3 py-1 rounded-md text-sm font-medium text-gray-500 hover:text-gray-900 transition-all"
                            onclick="setFigmaMode('link')">Link</button>
                    </div>
                </div>

                <!-- Upload Mode -->
                <div id="figma-upload-area"
                    class="drop-zone border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-red-500 h-64 flex flex-col items-center justify-center relative bg-gray-50 hover:bg-red-50 transition-colors">
                    <input type="file" id="figma-input" multiple accept="image/*"
                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20">

                    <div id="figma-placeholder"
                        class="flex flex-col items-center justify-center w-full h-full transition-opacity duration-300">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4 group-hover:text-red-500"></i>
                        <p class="text-gray-700 font-medium">Drop Figma PNGs here</p>
                        <p class="text-sm text-gray-500 mt-1">or click to browse</p>
                        <div id="figma-file-list" class="mt-4 flex flex-wrap gap-2 justify-center"></div>
                    </div>

                    <img id="figma-preview"
                        class="hidden absolute inset-0 w-full h-full object-contain p-4 z-10 rounded-xl" />
                </div>

                <!-- Link Mode -->
                <div id="figma-link-area"
                    class="hidden h-64 flex flex-col items-center justify-center bg-gray-50 rounded-xl border border-gray-200 p-6">
                    <div class="w-full max-w-md">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Figma Node Link</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-link text-gray-400"></i>
                            </div>
                            <input type="text" id="figma-link-input"
                                placeholder="https://www.figma.com/design/...?node-id=..."
                                class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 sm:text-sm">
                        </div>
                        <p class="mt-2 text-xs text-gray-500">
                            Copy the link to a specific Frame or Node in Figma. Ensure the API Token is set in the
                            backend.
                        </p>
                    </div>
                </div>
            </div>

            <!-- App Source -->
            <div class="glass rounded-2xl p-6 bg-white">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold flex items-center gap-2 text-gray-800">
                        <i class="fas fa-mobile-alt text-gray-900"></i> App Implementation
                    </h2>

                    <!-- Toggle -->
                    <div class="flex bg-gray-100 rounded-lg p-1 border border-gray-200">
                        <button id="btn-mode-upload"
                            class="px-3 py-1 rounded-md text-sm font-medium bg-white text-gray-900 shadow-sm transition-all"
                            onclick="setMode('upload')">Upload</button>
                        <button id="btn-mode-adb"
                            class="px-3 py-1 rounded-md text-sm font-medium text-gray-500 hover:text-gray-900 transition-all"
                            onclick="setMode('adb')">ADB (Auto)</button>
                    </div>
                </div>

                <!-- Upload Mode -->
                <div id="app-upload-area"
                    class="drop-zone border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-red-500 h-64 flex flex-col items-center justify-center relative bg-gray-50 hover:bg-red-50 transition-colors">
                    <input type="file" id="app-input" multiple accept="image/*,.xml"
                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20">

                    <div id="app-placeholder"
                        class="flex flex-col items-center justify-center w-full h-full transition-opacity duration-300">
                        <i class="fas fa-images text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-700 font-medium">Drop App Screenshots & XML here</p>
                        <p class="text-sm text-gray-500 mt-1">or click to browse</p>
                        <div id="app-file-list" class="mt-4 flex flex-wrap gap-2 justify-center"></div>
                    </div>

                    <img id="app-preview"
                        class="hidden absolute inset-0 w-full h-full object-contain p-4 z-10 rounded-xl" />
                </div>

                <!-- ADB Mode -->
                <div id="app-adb-area"
                    class="hidden h-64 flex flex-col items-center justify-center bg-gray-50 rounded-xl border border-gray-200">
                    <div
                        class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4 animate-pulse-ring">
                        <i class="fas fa-wifi text-2xl text-red-600"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">Ready to Connect</h3>
                    <p class="text-gray-500 text-sm mt-2 text-center px-8">
                        Ensure your device is connected via USB and USB Debugging is enabled.
                    </p>
                </div>
            </div>
        </div>

        <!-- Settings & Action -->
        <div class="flex flex-col items-center gap-6 mb-16">
            <!-- Advanced Settings Toggle -->
            <button onclick="document.getElementById('settings-panel').classList.toggle('hidden')"
                class="text-sm text-gray-500 hover:text-red-600 flex items-center gap-1 transition-colors">
                <i class="fas fa-sliders-h"></i> Advanced Settings
            </button>

            <div id="settings-panel"
                class="hidden w-full max-w-2xl glass p-6 rounded-xl bg-white grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs text-gray-500 mb-1 font-semibold">App Analysis Mode</label>
                    <select id="analysis-mode"
                        class="w-full bg-gray-50 border border-gray-300 rounded px-3 py-2 text-sm text-gray-900 focus:border-red-500 outline-none focus:ring-1 focus:ring-red-500">
                        <option value="xml">XML (UIAutomator)</option>
                        <option value="ai" selected>AI (Visual Analysis)</option>
                    </select>
                </div>
                <div class="col-span-2 border-t border-gray-100 pt-4 mt-2">
                    <div class="flex items-center justify-between mb-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="auto-crop" checked onchange="toggleCropInputs()"
                                class="w-4 h-4 text-red-600 rounded border-gray-300 focus:ring-red-500">
                            <span class="text-sm font-semibold text-gray-700">Auto-Crop System Bars</span>
                        </label>
                        <span class="text-xs text-gray-400">(Detects Status/Nav Bars)</span>
                    </div>

                    <div id="manual-crop-inputs" class="opacity-50 pointer-events-none transition-opacity space-y-3">
                        <!-- App Crop -->
                        <div>
                            <div class="text-xs font-bold text-gray-700 mb-1">App Crop (px)</div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <input type="number" id="app-crop-top" placeholder="Top" value="0"
                                        class="w-full bg-gray-50 border border-gray-300 rounded px-2 py-1 text-sm focus:border-red-500 outline-none">
                                </div>
                                <div>
                                    <input type="number" id="app-crop-bottom" placeholder="Bottom" value="0"
                                        class="w-full bg-gray-50 border border-gray-300 rounded px-2 py-1 text-sm focus:border-red-500 outline-none">
                                </div>
                            </div>
                        </div>
                        <!-- Figma Crop -->
                        <div>
                            <div class="text-xs font-bold text-gray-700 mb-1">Figma Crop (px)</div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <input type="number" id="figma-crop-top" placeholder="Top" value="0"
                                        class="w-full bg-gray-50 border border-gray-300 rounded px-2 py-1 text-sm focus:border-red-500 outline-none">
                                </div>
                                <div>
                                    <input type="number" id="figma-crop-bottom" placeholder="Bottom" value="0"
                                        class="w-full bg-gray-50 border border-gray-300 rounded px-2 py-1 text-sm focus:border-red-500 outline-none">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="runAudit()" id="run-btn"
                class="group relative px-8 py-4 bg-vodafone-red hover:bg-red-700 text-white rounded-xl font-bold text-lg shadow-lg shadow-red-200 transition-all hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                <span class="flex items-center gap-2">
                    <i class="fas fa-play"></i> Run Audit
                </span>
            </button>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay"
            class="hidden fixed inset-0 bg-white/90 backdrop-blur-sm z-50 flex flex-col items-center justify-center">
            <div class="w-16 h-16 border-4 border-red-200 border-t-red-600 rounded-full animate-spin mb-4"></div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Analyzing...</h2>
            <p class="text-gray-500" id="loading-text">Processing images and running AI models</p>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden space-y-12">

            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass p-6 rounded-xl border-l-4 border-green-500 bg-white">
                    <div class="text-gray-500 text-sm font-medium mb-1">Passed</div>
                    <div class="text-3xl font-bold text-gray-900" id="res-pass">0</div>
                </div>
                <div class="glass p-6 rounded-xl border-l-4 border-red-500 bg-white">
                    <div class="text-gray-500 text-sm font-medium mb-1">Failed</div>
                    <div class="text-3xl font-bold text-gray-900" id="res-fail">0</div>
                </div>
                <div class="glass p-6 rounded-xl border-l-4 border-yellow-500 bg-white">
                    <div class="text-gray-500 text-sm font-medium mb-1">Warnings</div>
                    <div class="text-3xl font-bold text-gray-900" id="res-warn">0</div>
                </div>
                <div class="glass p-6 rounded-xl border-l-4 border-blue-500 bg-white">
                    <div class="text-gray-500 text-sm font-medium mb-1">Match Score</div>
                    <div class="text-3xl font-bold text-gray-900" id="res-score">0%</div>
                </div>
            </div>

            <!-- Detailed Results Container -->
            <div id="results-container" class="space-y-8">
                <!-- Dynamic Content will be injected here -->
            </div>

        </div>

    </main>

    <script>
        let currentMode = 'upload';
        let currentFigmaMode = 'upload';
        let currentSummary = null; // Store summary data globally for updates

        function updateSummaryUI() {
            if (!currentSummary) return;

            // Recalc Percentage
            let total = currentSummary.total_matched; // This now represents "Active" matched items, or should we keep total static?
            // User requested: "increase its ratio". This implies removing it from the denominator or numerator effectively.
            
            // Actually, if we ignore, we should probably remove it from both calculations if we treat it as "False Positive" (didn't happen).
            // OR if we treat it as "Ignore this failure", maybe it becomes a PASS?
            // "if AI's wrong ignore that control and increase its ratio" -> implies removing the failure.
            
            // Let's adopt the strategy: Ignored items are REMOVED from the stats calculation entirely.
            // So Total Matched decreases.
            
            let layoutPct = 0;
            // stylePct = 0; // Not displayed in summary cards but good to have
            let overallPct = 0;

            if (total > 0) {
                 // Formula from python: ((layout_success + style_success) / (2 * total)) * 100
                 overallPct = ((currentSummary.layout_success_count + currentSummary.style_success_count) / (2 * total)) * 100.0;
            } else {
                overallPct = 100; // If everything is ignored, maybe 100? Or 0? Let's say 0 or keep last.
                if (total === 0) overallPct = 0; 
            }

            document.getElementById('res-pass').textContent = (currentSummary.layout_success_count + currentSummary.style_success_count);
            document.getElementById('res-fail').textContent = currentSummary.error_count;
            document.getElementById('res-warn').textContent = currentSummary.warning_count;
            document.getElementById('res-score').textContent = overallPct.toFixed(1) + '%';
        }

        function toggleIgnore(checkbox, rowId) {
            const row = document.getElementById('row-' + rowId);
            if (!row || !currentSummary) return;

            const isIgnored = checkbox.checked;
            const layoutStatus = row.getAttribute('data-layout-status').toLowerCase();
            const styleStatus = row.getAttribute('data-style-status').toLowerCase();

            if (isIgnored) {
                row.classList.add('opacity-40', 'line-through', 'bg-gray-100');
                row.classList.remove('hover:bg-blue-50'); // Disable hover effect visually

                // Remove from stats
                currentSummary.total_matched--;

                if (layoutStatus === 'pass') currentSummary.layout_success_count--;
                else if (layoutStatus === 'fail') currentSummary.error_count--;

                if (styleStatus === 'pass') currentSummary.style_success_count--;
                else if (styleStatus === 'audit') currentSummary.warning_count--;
                // Note: styleStatus can be 'fail' too, usually bundled in warning or error? 
                // In Python code: style fail adds to nothing? Wait.
                // Python: if sty['status'] == 'audit' -> warning. pass -> style_success. 
                // It seems 'fail' for style isn't explicitly counted in error_count in Python summary? 
                // Python: l_status == 'fail' -> error_count. 
                // Check report_generator logic if style fail affects error_count.
                // In comparator.py: l_status is 'fail' if dim, spc, or pad fail. Style is separate. 
                // Ah, Python summary doesn't seem to have style_fail_count.
                // Let's stick to modifying what we have.
                
            } else {
                row.classList.remove('opacity-40', 'line-through', 'bg-gray-100');
                row.classList.add('hover:bg-blue-50');

                // Add back to stats
                currentSummary.total_matched++;

                if (layoutStatus === 'pass') currentSummary.layout_success_count++;
                else if (layoutStatus === 'fail') currentSummary.error_count++;

                if (styleStatus === 'pass') currentSummary.style_success_count++;
                else if (styleStatus === 'audit') currentSummary.warning_count++;
            }
            
            updateSummaryUI();
        }


        // Check ADB Status on Load
        async function checkADB() {
            try {
                const res = await fetch('/adb/check');
                const data = await res.json();
                const statusEl = document.getElementById('adb-status');
                if (data.status === 'connected') {
                    statusEl.innerHTML = '<div class="w-2 h-2 rounded-full bg-green-500"></div> ADB Connected';
                    statusEl.classList.replace('text-gray-500', 'text-green-600');
                    statusEl.classList.replace('bg-gray-100', 'bg-green-50');
                } else {
                    statusEl.innerHTML = '<div class="w-2 h-2 rounded-full bg-red-500"></div> ADB Disconnected';
                    statusEl.classList.replace('text-gray-500', 'text-red-600');
                    statusEl.classList.replace('bg-gray-100', 'bg-red-50');
                }
            } catch (e) {
                console.error("ADB Check failed", e);
            }
        }
        checkADB();

        function setMode(mode) {
            currentMode = mode;
            const btnUpload = document.getElementById('btn-mode-upload');
            const btnAdb = document.getElementById('btn-mode-adb');
            const areaUpload = document.getElementById('app-upload-area');
            const areaAdb = document.getElementById('app-adb-area');

            if (mode === 'upload') {
                btnUpload.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
                btnUpload.classList.remove('text-gray-500', 'hover:text-gray-900');
                btnAdb.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
                btnAdb.classList.add('text-gray-500', 'hover:text-gray-900');

                areaUpload.classList.remove('hidden');
                areaAdb.classList.add('hidden');
            } else {
                btnAdb.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
                btnAdb.classList.remove('text-gray-500', 'hover:text-gray-900');
                btnUpload.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
                btnUpload.classList.add('text-gray-500', 'hover:text-gray-900');

                areaUpload.classList.add('hidden');
                areaAdb.classList.remove('hidden');
            }
        }

        function setFigmaMode(mode) {
            currentFigmaMode = mode;
            const btnUpload = document.getElementById('btn-figma-upload');
            const btnLink = document.getElementById('btn-figma-link');
            const areaUpload = document.getElementById('figma-upload-area');
            const areaLink = document.getElementById('figma-link-area');

            if (mode === 'upload') {
                btnUpload.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
                btnUpload.classList.remove('text-gray-500', 'hover:text-gray-900');
                btnLink.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
                btnLink.classList.add('text-gray-500', 'hover:text-gray-900');

                areaUpload.classList.remove('hidden');
                areaLink.classList.add('hidden');
            } else {
                btnLink.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
                btnLink.classList.remove('text-gray-500', 'hover:text-gray-900');
                btnUpload.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
                btnUpload.classList.add('text-gray-500', 'hover:text-gray-900');

                areaUpload.classList.add('hidden');
                areaLink.classList.remove('hidden');
            }
        }

        // File Input Handling
        function handleFileSelect(inputId, listId, previewId, placeholderId) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            const preview = document.getElementById(previewId);
            const placeholder = document.getElementById(placeholderId);

            input.addEventListener('change', (e) => {
                list.innerHTML = '';
                const files = Array.from(e.target.files);

                if (files.length > 0) {
                    const file = files[0];

                    // Show Preview if Image
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            preview.src = e.target.result;
                            preview.classList.remove('hidden');
                            placeholder.classList.add('opacity-0'); // Hide placeholder but keep layout
                        };
                        reader.readAsDataURL(file);
                    } else {
                        // Hide preview if not image (e.g. XML)
                        preview.classList.add('hidden');
                        placeholder.classList.remove('opacity-0');
                    }

                    // List files
                    files.forEach(f => {
                        const tag = document.createElement('span');
                        tag.className = 'px-2 py-1 bg-gray-100 rounded text-xs text-gray-700 border border-gray-200 z-30 relative';
                        tag.textContent = f.name;
                        list.appendChild(tag);
                    });
                } else {
                    preview.classList.add('hidden');
                    placeholder.classList.remove('opacity-0');
                }
            });
        }
        handleFileSelect('figma-input', 'figma-file-list', 'figma-preview', 'figma-placeholder');
        handleFileSelect('app-input', 'app-file-list', 'app-preview', 'app-placeholder');

        function toggleCropInputs() {
            const isAuto = document.getElementById('auto-crop').checked;
            const inputs = document.getElementById('manual-crop-inputs');
            if (isAuto) {
                inputs.classList.add('opacity-50', 'pointer-events-none');
            } else {
                inputs.classList.remove('opacity-50', 'pointer-events-none');
            }
        }

        async function runAudit() {
            const figmaInput = document.getElementById('figma-input');
            const appInput = document.getElementById('app-input');
            const useAdb = currentMode === 'adb'; // Use currentMode for ADB toggle
            const analysisMode = document.getElementById('analysis-mode').value;

            // Crop Logic
            const isAutoCrop = document.getElementById('auto-crop').checked;
            let figmaCropTop = 0, figmaCropBottom = 0;
            let appCropTop = 0, appCropBottom = 0;

            if (isAutoCrop) {
                figmaCropTop = -1; figmaCropBottom = -1;
                appCropTop = -1; appCropBottom = -1;
            } else {
                figmaCropTop = parseInt(document.getElementById('figma-crop-top').value) || 0;
                figmaCropBottom = parseInt(document.getElementById('figma-crop-bottom').value) || 0;
                appCropTop = parseInt(document.getElementById('app-crop-top').value) || 0;
                appCropBottom = parseInt(document.getElementById('app-crop-bottom').value) || 0;
            }

            if (currentFigmaMode === 'upload' && !figmaInput.files.length) {
                alert("Please upload at least one Figma design.");
                return;
            }

            const figmaLinkVal = document.getElementById('figma-link-input').value;
            if (currentFigmaMode === 'link' && !figmaLinkVal) {
                alert("Please enter a valid Figma Link.");
                return;
            }

            if (!useAdb && !appInput.files.length) {
                alert("Please upload App screenshots or enable ADB mode.");
                return;
            }

            // Show Loading
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('results-section').classList.add('hidden');

            const formData = new FormData();

            // Add Figma Files or Link
            if (currentFigmaMode === 'upload') {
                for (let i = 0; i < figmaInput.files.length; i++) {
                    formData.append('figma_files', figmaInput.files[i]);
                }
            } else {
                formData.append('figma_link', figmaLinkVal);
            }

            // Add App Files (if not ADB)
            if (!useAdb) {
                for (let i = 0; i < appInput.files.length; i++) {
                    formData.append('app_files', appInput.files[i]);
                }
            }

            formData.append('use_adb', useAdb);
            formData.append('app_analysis_mode', analysisMode);

            // Send separate crops
            formData.append('figma_crop_top', figmaCropTop);
            formData.append('figma_crop_bottom', figmaCropBottom);
            formData.append('app_crop_top', appCropTop);
            formData.append('app_crop_bottom', appCropBottom);

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (!response.ok || result.error) {
                    showError(result.error || "Unknown server error.");
                    document.getElementById('loading-overlay').classList.add('hidden');
                    return;
                }

                renderResults(result);
            } catch (error) {
                console.error('Error:', error);
                showError("Network or Server Error: " + error.message);
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        function renderResults(data) {
            const section = document.getElementById('results-section');
            section.classList.remove('hidden');

            // Scroll to results
            section.scrollIntoView({ behavior: 'smooth' });

            // Update Summary
            currentSummary = JSON.parse(JSON.stringify(data.summary)); // Deep copy using JSON to avoid ref issues
            updateSummaryUI();
            
            // Old static render - replaced by updateSummaryUI
            // document.getElementById('res-pass').textContent = (summary.layout_success_count + summary.style_success_count);
            // document.getElementById('res-fail').textContent = summary.error_count;
            // document.getElementById('res-warn').textContent = summary.warning_count;
            // document.getElementById('res-score').textContent = summary.overall_match_pct + '%';

            // Render Parts
            const container = document.getElementById('results-container');
            container.innerHTML = '';

            data.parts.forEach(part => {
                const partEl = document.createElement('div');
                partEl.className = 'glass rounded-xl border border-gray-200 overflow-hidden bg-white shadow-sm';

                // Header
                partEl.innerHTML = `
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-semibold text-lg text-gray-900">Part ${part.part_index}</h3>
                        <span class="text-xs text-gray-500">Comparison Result</span>
                    </div>
                `;

                // Content
                const content = document.createElement('div');
                content.className = 'p-6';

                const gridHtml = `
                    <div class="flex flex-col lg:flex-row gap-8">
                        <!-- Left Column: Sticky Images -->
                        <div class="lg:w-1/2">
                            <div class="sticky top-24 space-y-6">
                                <!-- Figma Image -->
                                <div class="relative group">
                                    <div class="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                        <i class="fab fa-figma text-gray-500"></i> Figma Design
                                    </div>
                                    <div class="rounded-lg border border-gray-200 bg-gray-100 shadow-inner h-[50vh] flex items-center justify-center bg-gray-50 overflow-hidden">
                                        <div class="relative">
                                            <img src="/files/${part.image_pair.figma}?t=${Date.now()}" id="img-figma-${part.part_index}" class="max-w-full max-h-[50vh] w-auto h-auto block" onload="setupCanvas(this, 'canvas-figma-${part.part_index}')">
                                            <canvas id="canvas-figma-${part.part_index}" class="absolute inset-0 z-10 cursor-crosshair" onmousemove="handleCanvasHover(event, '${part.part_index}', 'figma')" onmouseleave="hideTooltip()"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <!-- App Image -->
                                <div class="relative group">
                                    <div class="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                        <i class="fas fa-mobile-alt text-gray-500"></i> App Implementation
                                    </div>
                                    <div class="rounded-lg border border-gray-200 bg-gray-100 shadow-inner h-[50vh] flex items-center justify-center bg-gray-50 overflow-hidden">
                                        <div class="relative">
                                            <img src="/files/${part.image_pair.app}?t=${Date.now()}" id="img-app-${part.part_index}" class="max-w-full max-h-[50vh] w-auto h-auto block" onload="setupCanvas(this, 'canvas-app-${part.part_index}')">
                                            <canvas id="canvas-app-${part.part_index}" class="absolute inset-0 z-10 cursor-crosshair" onmousemove="handleCanvasHover(event, '${part.part_index}', 'app')" onmouseleave="hideTooltip()"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Scrollable Table -->
                        <div class="lg:w-1/2">
                            <h4 class="text-md font-bold text-gray-800 mb-3 border-l-4 border-vodafone-red pl-2">Component Comparison Table</h4>
                            <div class="overflow-x-auto border border-gray-200 rounded-lg mb-8 shadow-sm">
                                <table class="w-full text-left text-sm text-gray-600">
                                    <thead class="bg-gray-100 text-gray-700 uppercase font-semibold sticky top-0 z-20 text-xs shadow-sm">
                                        <tr>
                                            <th class="px-4 py-3 bg-gray-100 w-16 text-center">Ignore</th>
                                            <th class="px-4 py-3 bg-gray-100">Component Name</th>
                                            <th class="px-4 py-3 bg-gray-100 text-center">Layout</th>
                                            <th class="px-4 py-3 bg-gray-100 text-center">Style</th>
                                            <th class="px-4 py-3 bg-gray-100">Details</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100 bg-white">
                `;


                let tableRows = '';
                const matched = part.comparison_results?.matched_components || [];
                matched.forEach((comp, idx) => {
                    const name = comp.name || "Unnamed";
                    const layoutStatus = comp.overall_layout_status || "N/A";
                    const styleStatus = comp.overall_style_status || "N/A";

                    const getBadge = (status) => {
                        const s = status.toLowerCase();
                        if (s === 'pass') return `<span class="px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-700 border border-green-200">PASS</span>`;
                        if (s === 'fail') return `<span class="px-2 py-1 rounded text-xs font-bold bg-red-100 text-red-700 border border-red-200">FAIL</span>`;
                        if (s === 'audit') return `<span class="px-2 py-1 rounded text-xs font-bold bg-yellow-100 text-yellow-700 border border-yellow-200">WARN</span>`;
                        return `<span class="px-2 py-1 rounded text-xs font-bold bg-gray-100 text-gray-600 border border-gray-200">${status}</span>`;
                    };

                    // Prepare Bounds Data
                    const fBounds = JSON.stringify(comp.raw_data.figma_analysis.bounds);
                    const aBounds = JSON.stringify(comp.raw_data.app_analysis.bounds);

                    tableRows += `
                        <tr class="hover:bg-blue-50 transition-colors cursor-pointer group"
                            id="row-${part.part_index}-${idx}"
                            onclick="highlightComponent(this, ${part.part_index})"
                            data-layout-status="${layoutStatus}"
                            data-style-status="${styleStatus}"
                            data-figma-bounds='${fBounds}'
                            data-app-bounds='${aBounds}'>
                            <td class="px-4 py-3 text-center" onclick="event.stopPropagation()">
                                <input type="checkbox" onchange="toggleIgnore(this, '${part.part_index}-${idx}')" class="w-4 h-4 text-gray-500 rounded border-gray-300 focus:ring-gray-500">
                            </td>
                            <td class="px-4 py-3 font-medium text-gray-900 group-hover:text-vodafone-red flex items-center gap-2">
                                <i class="fas fa-cube text-gray-300 group-hover:text-vodafone-red transition-colors"></i> ${name}
                            </td>
                            <td class="px-4 py-3 text-center">${getBadge(layoutStatus)}</td>
                            <td class="px-4 py-3 text-center">${getBadge(styleStatus)}</td>
                            <td class="px-4 py-3 text-xs font-mono text-gray-500">
                                ${comp.tests?.styles?.messages?.join('<br>') || '-'}
                            </td>
                        </tr>
                    `;
                });

                let unmatchedHtml = '';
                // Unmatched Figma Components (Control List)
                const unmatchedFigma = part.comparison_results?.unmatched_figma || [];
                if (unmatchedFigma.length > 0) {
                    unmatchedHtml += `
                        <div class="mt-8">
                            <h4 class="text-md font-bold text-gray-800 mb-3 border-l-4 border-gray-400 pl-2">Figma Component Control List (Unmatched)</h4>
                            <div class="overflow-x-auto max-h-64 overflow-y-auto border border-gray-200 rounded-lg shadow-sm">
                                <table class="w-full text-left text-sm text-gray-600">
                                    <thead class="bg-gray-100 text-gray-700 uppercase font-semibold sticky top-0 z-20 text-xs shadow-sm">
                                        <tr>
                                            <th class="px-4 py-3 bg-gray-100">Component Name</th>
                                            <th class="px-4 py-3 bg-gray-100">Expected Properties</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100 bg-white">
                    `;

                    unmatchedFigma.forEach(comp => {
                        const name = comp.name || "Unnamed";
                        const props = `
                            <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
                                <span>W: ${Math.round(comp.bounds?.w || 0)}</span>
                                <span>H: ${Math.round(comp.bounds?.h || 0)}</span>
                                <span>X: ${Math.round(comp.bounds?.x || 0)}</span>
                                <span>Y: ${Math.round(comp.bounds?.y || 0)}</span>
                            </div>
                        `;
                        const fBounds = JSON.stringify(comp.bounds);

                        unmatchedHtml += `
                            <tr class="hover:bg-gray-50 transition-colors cursor-pointer"
                                onclick="highlightFigmaOnly(this, ${part.part_index})"
                                data-figma-bounds='${fBounds}'>
                                <td class="px-4 py-3 font-medium text-gray-900">${name}</td>
                                <td class="px-4 py-3 font-mono text-gray-500">${props}</td>
                            </tr>
                        `;
                    });
                    unmatchedHtml += `</tbody></table></div></div>`;
                }

                const closingHtml = `
                                    </tbody>
                                </table>
                            </div>
                            ${unmatchedHtml}
                        </div>
                    </div>
                `;

                content.innerHTML = gridHtml + tableRows + closingHtml;
                partEl.appendChild(content);
                container.appendChild(partEl);

                // Store data for hover
                // We need to access this data globally or attach it to the DOM
                // Let's attach it to the canvas elements for easy access
                setTimeout(() => {
                    const canvasF = document.getElementById(`canvas-figma-${part.part_index}`);
                    const canvasA = document.getElementById(`canvas-app-${part.part_index}`);
                    if (canvasF) canvasF.dataset.components = JSON.stringify(
                        (part.comparison_results.matched_components || []).map(m => m.raw_data.figma_analysis)
                            .concat(part.comparison_results.unmatched_figma || [])
                    );
                    if (canvasA) canvasA.dataset.components = JSON.stringify(
                        (part.comparison_results.matched_components || []).map(m => m.raw_data.app_analysis)
                            .concat(part.comparison_results.unmatched_app || [])
                    );
                }, 500);
            });
        }

        // Canvas Setup
        function setupCanvas(img, canvasId) {
            const canvas = document.getElementById(canvasId);

            const updateSize = () => {
                if (img.width > 0 && img.height > 0) {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    // Redraw if there was an active highlight
                    if (activeRow) {
                        const partIndex = canvasId.split('-').pop();
                        // Re-trigger highlight to redraw on new size
                        // We need to find which part this is.
                        // Actually, highlightComponent redraws both.
                        // But we don't have easy access to row here.
                        // It's fine, user can click again or we rely on the fact that 
                        // usually resize happens on window resize which we might not handle perfectly for active highlight yet.
                        // But for initial load, this ensures canvas has size.
                    }
                }
            };

            // Initial check
            if (img.complete) updateSize();
            else img.onload = updateSize;

            // Robust resize observation
            const resizeObserver = new ResizeObserver(() => {
                updateSize();
            });
            resizeObserver.observe(img);
        }

        let activeRow = null;

        function highlightComponent(row, partIndex) {
            // Toggle Active State
            if (activeRow) activeRow.classList.remove('bg-blue-100');
            if (activeRow === row) {
                activeRow = null;
                clearCanvases(partIndex);
                return;
            }

            activeRow = row;
            row.classList.add('bg-blue-100');

            // Get Data
            const fBounds = JSON.parse(row.getAttribute('data-figma-bounds'));
            const aBounds = JSON.parse(row.getAttribute('data-app-bounds'));

            console.log("Highlighting:", { partIndex, fBounds, aBounds });

            drawRect(`img-figma-${partIndex}`, `canvas-figma-${partIndex}`, fBounds, '#00C853'); // Green for Figma
            drawRect(`img-app-${partIndex}`, `canvas-app-${partIndex}`, aBounds, '#E60000'); // Red for App
        }

        function highlightFigmaOnly(row, partIndex) {
            if (activeRow) activeRow.classList.remove('bg-blue-100');
            activeRow = row;
            row.classList.add('bg-blue-100');

            clearCanvases(partIndex);
            const fBounds = JSON.parse(row.getAttribute('data-figma-bounds'));
            drawRect(`img-figma-${partIndex}`, `canvas-figma-${partIndex}`, fBounds, '#FF9100'); // Orange for Unmatched
        }

        function clearCanvases(partIndex) {
            const c1 = document.getElementById(`canvas-figma-${partIndex}`);
            const c2 = document.getElementById(`canvas-app-${partIndex}`);
            if (c1) c1.getContext('2d').clearRect(0, 0, c1.width, c1.height);
            if (c2) c2.getContext('2d').clearRect(0, 0, c2.width, c2.height);
        }

        function drawRect(imgId, canvasId, bounds, color) {
            const img = document.getElementById(imgId);
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');

            // Clear previous
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Calculate Scale
            // bounds are in natural image coordinates
            // canvas is sized to displayed image size (img.width, img.height)
            // So we need to scale bounds by (displayed / natural)

            const scaleX = img.width / img.naturalWidth;
            const scaleY = img.height / img.naturalHeight;

            const x = bounds.x * scaleX;
            const y = bounds.y * scaleY;
            const w = bounds.w * scaleX;
            const h = bounds.h * scaleY;

            // Draw
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.strokeRect(x, y, w, h);

            // Fill with transparent color
            ctx.fillStyle = color + '33'; // 20% opacity
            ctx.fillRect(x, y, w, h);
        }
        // --- BALLOON TOOLTIP LOGIC ---
        const tooltip = document.createElement('div');
        tooltip.id = 'balloon-tooltip';
        tooltip.className = 'fixed z-50 hidden bg-gray-900 text-white text-xs rounded px-3 py-2 shadow-xl pointer-events-none transform -translate-x-1/2 -translate-y-full mb-2 transition-opacity duration-200';
        tooltip.style.maxWidth = '250px';
        tooltip.innerHTML = `
            <div class="font-bold mb-1 text-yellow-400" id="tt-title"></div>
            <div class="text-gray-300" id="tt-desc"></div>
            <div class="absolute bottom-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-900 rotate-45"></div>
        `;
        document.body.appendChild(tooltip);

        function handleCanvasHover(e, partIndex, type) {
            const canvas = e.target;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            // Mouse pos relative to canvas (scaled to natural image size)
            // Wait! The canvas is sized to the displayed image size in setupCanvas?
            // No, setupCanvas sets canvas.width = img.naturalWidth usually for high res drawing
            // Let's check setupCanvas... it sets canvas.width = img.width (displayed width)
            // BUT we need to map mouse pos to the coordinate system of the components (which are usually natural size)

            // Assuming components bounds are in NATURAL image coordinates.
            // And assuming we want to check collision in NATURAL coordinates.

            // Get the image element to find natural size
            const imgId = type === 'figma' ? `img-figma-${partIndex}` : `img-app-${partIndex}`;
            const img = document.getElementById(imgId);
            if (!img) return;

            const mouseX = (e.clientX - rect.left) * (img.naturalWidth / rect.width);
            const mouseY = (e.clientY - rect.top) * (img.naturalHeight / rect.height);

            const components = JSON.parse(canvas.dataset.components || '[]');

            // Find component under mouse (reverse to find top-most)
            let found = null;
            for (let i = components.length - 1; i >= 0; i--) {
                const c = components[i];
                if (!c || !c.bounds) continue;
                const b = c.bounds;
                if (mouseX >= b.x && mouseX <= b.x + b.w &&
                    mouseY >= b.y && mouseY <= b.y + b.h) {
                    found = c;
                    break;
                }
            }

            if (found) {
                showTooltip(e.clientX, e.clientY, found);
            } else {
                hideTooltip();
            }
        }

        function showTooltip(x, y, component) {
            const tt = document.getElementById('balloon-tooltip');
            const title = document.getElementById('tt-title');
            const desc = document.getElementById('tt-desc');

            title.textContent = component.name || component.type || 'Unknown';
            desc.textContent = `Type: ${component.type}\nText: ${component.text_content || '-'}`;

            tt.style.left = x + 'px';
            tt.style.top = (y - 10) + 'px'; // 10px offset
            tt.classList.remove('hidden');
            tt.classList.add('opacity-100');
        }

        function hideTooltip() {
            const tt = document.getElementById('balloon-tooltip');
            tt.classList.add('hidden');
            tt.classList.remove('opacity-100');
        }

        // --- ERROR POPUP LOGIC ---
        function showError(message) {
            // Create modal if not exists
            let modal = document.getElementById('error-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'error-modal';
                modal.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-50 hidden';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-2xl p-6 max-w-md w-full mx-4 transform transition-all scale-100">
                        <div class="flex items-center gap-3 mb-4 text-red-600">
                            <i class="fas fa-exclamation-circle text-3xl"></i>
                            <h3 class="text-xl font-bold">Error Occurred</h3>
                        </div>
                        <p class="text-gray-700 mb-6" id="error-message">Something went wrong.</p>
                        <div class="flex justify-end">
                            <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded focus:outline-none focus:shadow-outline transition duration-150 ease-in-out">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('error-message').textContent = message;
            modal.classList.remove('hidden');
        }

    </script>
</body>

</html>